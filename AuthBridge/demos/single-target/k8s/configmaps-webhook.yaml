# ConfigMaps required for AuthBridge webhook injection
# Apply these to any namespace where you want to use AuthBridge with the webhook
#
# Usage:
#   kubectl apply -f configmaps-webhook.yaml -n <your-namespace>
#
# Note: Update the namespace in metadata if applying to a different namespace

---
# environments ConfigMap - Used by kagenti-client-registration container
apiVersion: v1
kind: ConfigMap
metadata:
  name: environments
  namespace: team1
data:
  SPIRE_ENABLED: "true"
  KEYCLOAK_URL: "http://keycloak-service.keycloak.svc:8080"
  KEYCLOAK_REALM: "demo"
  # Demo/development only: do NOT use hardcoded admin credentials in production.
  # For production deployments, supply these via a Kubernetes Secret and reference
  # them from your Pod/Deployment using env.valueFrom.secretKeyRef instead of this ConfigMap.
  KEYCLOAK_ADMIN_USERNAME: "admin"
  KEYCLOAK_ADMIN_PASSWORD: "admin"

---
# authbridge-config ConfigMap - Used by envoy-proxy for token exchange and inbound validation
apiVersion: v1
kind: ConfigMap
metadata:
  name: authbridge-config
  namespace: team1
data:
  TOKEN_URL: "http://keycloak-service.keycloak.svc:8080/realms/demo/protocol/openid-connect/token"
  # ISSUER: Required. Keycloak frontend URL used as token issuer for inbound JWT validation.
  # Must match the "iss" claim in tokens (Keycloak's frontend URL).
  ISSUER: "http://keycloak.localtest.me:8080/realms/demo"
  # EXPECTED_AUDIENCE: Optional. Expected audience for inbound JWT validation.
  # For SPIFFE-based deployments, this should match the agent's SPIFFE ID.
  # Format: spiffe://localtest.me/ns/<namespace>/sa/<service-account>
  # Update this value if deploying to a different namespace or using a different service account.
  # If not set, audience validation is skipped (issuer and signature validation still occur).
  EXPECTED_AUDIENCE: "spiffe://localtest.me/ns/team1/sa/agent"
  TARGET_AUDIENCE: "auth-target"
  TARGET_SCOPES: "openid auth-target-aud"

---
# spiffe-helper-config ConfigMap - Used by spiffe-helper container (SPIRE mode only)
apiVersion: v1
kind: ConfigMap
metadata:
  name: spiffe-helper-config
  namespace: team1
data:
  helper.conf: |
    agent_address = "/spiffe-workload-api/spire-agent.sock"
    cmd = ""
    cmd_args = ""
    cert_dir = "/opt"
    renew_signal = ""
    svid_file_name = "svid.pem"
    svid_key_file_name = "svid_key.pem"
    svid_bundle_file_name = "svid_bundle.pem"
    jwt_svids = [{jwt_audience="kagenti", jwt_svid_file_name="jwt_svid.token"}]

---
# envoy-config ConfigMap - Envoy proxy configuration for traffic interception
apiVersion: v1
kind: ConfigMap
metadata:
  name: envoy-config
  namespace: team1
data:
  envoy.yaml: |
    admin:
      address:
        socket_address:
          protocol: TCP
          address: 127.0.0.1
          port_value: 9901

    static_resources:
      listeners:
      - name: outbound_listener
        address:
          socket_address:
            protocol: TCP
            address: 0.0.0.0
            port_value: 15123
        listener_filters:
        - name: envoy.filters.listener.original_dst
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.original_dst.v3.OriginalDst
        - name: envoy.filters.listener.tls_inspector
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.tls_inspector.v3.TlsInspector
        filter_chains:
        # TLS passthrough: forward HTTPS traffic as-is via TCP proxy
        - filter_chain_match:
            transport_protocol: tls
          filters:
          - name: envoy.filters.network.tcp_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
              stat_prefix: outbound_tls_passthrough
              cluster: original_destination
        # Plaintext HTTP: inspect and process via ext_proc
        - filter_chain_match:
            transport_protocol: raw_buffer
          filters:
          - name: envoy.filters.network.http_connection_manager
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
              stat_prefix: outbound_http
              codec_type: AUTO
              route_config:
                name: outbound_routes
                virtual_hosts:
                - name: catch_all
                  domains: ["*"]
                  routes:
                  - match:
                      prefix: "/"
                    route:
                      cluster: original_destination
              http_filters:
              - name: envoy.filters.http.ext_proc
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.ext_proc.v3.ExternalProcessor
                  grpc_service:
                    envoy_grpc:
                      cluster_name: ext_proc_cluster
                    timeout: 30s
                  processing_mode:
                    request_header_mode: SEND
                    response_header_mode: SKIP
                    request_body_mode: NONE
                    response_body_mode: NONE
              - name: envoy.filters.http.router
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

      - name: inbound_listener
        address:
          socket_address:
            protocol: TCP
            address: 0.0.0.0
            port_value: 15124
        listener_filters:
        - name: envoy.filters.listener.original_dst
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.original_dst.v3.OriginalDst
        filter_chains:
        - filters:
          - name: envoy.filters.network.http_connection_manager
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
              stat_prefix: inbound_http
              codec_type: AUTO
              route_config:
                name: inbound_routes
                virtual_hosts:
                - name: local_app
                  domains: ["*"]
                  routes:
                  - match:
                      prefix: "/"
                    route:
                      cluster: original_destination
              http_filters:
              - name: envoy.filters.http.lua
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
                  inline_code: |
                    function envoy_on_request(request_handle)
                      request_handle:headers():add("x-authbridge-direction", "inbound")
                    end
              - name: envoy.filters.http.ext_proc
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.ext_proc.v3.ExternalProcessor
                  grpc_service:
                    envoy_grpc:
                      cluster_name: ext_proc_cluster
                    timeout: 30s
                  processing_mode:
                    request_header_mode: SEND
                    response_header_mode: SKIP
                    request_body_mode: NONE
                    response_body_mode: NONE
              - name: envoy.filters.http.router
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

      clusters:
      - name: original_destination
        connect_timeout: 30s
        type: ORIGINAL_DST
        lb_policy: CLUSTER_PROVIDED
        original_dst_lb_config:
          use_http_header: false

      - name: ext_proc_cluster
        connect_timeout: 5s
        type: STATIC
        lb_policy: ROUND_ROBIN
        http2_protocol_options: {}
        load_assignment:
          cluster_name: ext_proc_cluster
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: 127.0.0.1
                    port_value: 9090
