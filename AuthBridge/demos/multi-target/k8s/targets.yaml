# Multi-Target Demo - Target Services
#
# Three target services that validate tokens with different audiences.
# Each reuses the demo-app image with a different AUDIENCE env var.
---
apiVersion: v1
kind: Namespace
metadata:
  name: authbridge
  labels:
    istio.io/dataplane-mode: ambient
---
# Target Alpha
apiVersion: apps/v1
kind: Deployment
metadata:
  name: target-alpha
  namespace: authbridge
  labels:
    app: target-alpha
spec:
  replicas: 1
  selector:
    matchLabels:
      app: target-alpha
  template:
    metadata:
      labels:
        app: target-alpha
    spec:
      containers:
      - name: target-alpha
        image: demo-app:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8081
        env:
        - name: ISSUER
          value: "http://keycloak.localtest.me:8080/realms/demo"
        - name: JWKS_URL
          value: "http://keycloak-service.keycloak.svc.cluster.local:8080/realms/demo/protocol/openid-connect/certs"
        - name: AUDIENCE
          value: "target-alpha"
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "250m"
---
apiVersion: v1
kind: Service
metadata:
  name: target-alpha-service
  namespace: authbridge
spec:
  selector:
    app: target-alpha
  ports:
  - protocol: TCP
    port: 8081
    targetPort: 8081
  type: ClusterIP
---
# Target Beta
apiVersion: apps/v1
kind: Deployment
metadata:
  name: target-beta
  namespace: authbridge
  labels:
    app: target-beta
spec:
  replicas: 1
  selector:
    matchLabels:
      app: target-beta
  template:
    metadata:
      labels:
        app: target-beta
    spec:
      containers:
      - name: target-beta
        image: demo-app:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8081
        env:
        - name: ISSUER
          value: "http://keycloak.localtest.me:8080/realms/demo"
        - name: JWKS_URL
          value: "http://keycloak-service.keycloak.svc.cluster.local:8080/realms/demo/protocol/openid-connect/certs"
        - name: AUDIENCE
          value: "target-beta"
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "250m"
---
apiVersion: v1
kind: Service
metadata:
  name: target-beta-service
  namespace: authbridge
spec:
  selector:
    app: target-beta
  ports:
  - protocol: TCP
    port: 8081
    targetPort: 8081
  type: ClusterIP
---
# Target Gamma
apiVersion: apps/v1
kind: Deployment
metadata:
  name: target-gamma
  namespace: authbridge
  labels:
    app: target-gamma
spec:
  replicas: 1
  selector:
    matchLabels:
      app: target-gamma
  template:
    metadata:
      labels:
        app: target-gamma
    spec:
      containers:
      - name: target-gamma
        image: demo-app:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8081
        env:
        - name: ISSUER
          value: "http://keycloak.localtest.me:8080/realms/demo"
        - name: JWKS_URL
          value: "http://keycloak-service.keycloak.svc.cluster.local:8080/realms/demo/protocol/openid-connect/certs"
        - name: AUDIENCE
          value: "target-gamma"
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "250m"
---
apiVersion: v1
kind: Service
metadata:
  name: target-gamma-service
  namespace: authbridge
spec:
  selector:
    app: target-gamma
  ports:
  - protocol: TCP
    port: 8081
    targetPort: 8081
  type: ClusterIP
