# ConfigMaps for GitHub Issue Agent + AuthBridge Demo
#
# These ConfigMaps configure AuthBridge sidecar injection for the GitHub Issue Agent.
# The agent gets sidecars injected by the kagenti-webhook, and these ConfigMaps
# tell those sidecars how to authenticate with Keycloak and perform token exchange.
#
# Usage:
#   kubectl apply -f configmaps.yaml
#
# Note: These manifests default to namespace "team1". If you deploy to a different
#       namespace, update the metadata.namespace fields and EXPECTED_AUDIENCE (or
#       use kustomize) accordingly, and adjust the service account if needed.

---
# environments ConfigMap - Used by kagenti-client-registration container
# This configures how the client-registration sidecar connects to Keycloak
# to register the agent as an OAuth client.
apiVersion: v1
kind: ConfigMap
metadata:
  name: environments
  namespace: team1
data:
  SPIRE_ENABLED: "true"
  KEYCLOAK_URL: "http://keycloak-service.keycloak.svc:8080"
  KEYCLOAK_REALM: "demo"
  # Demo/development only: do NOT use hardcoded admin credentials in production.
  # For production deployments, supply these via a Kubernetes Secret and reference
  # them from your Pod/Deployment using env.valueFrom.secretKeyRef instead.
  KEYCLOAK_ADMIN_USERNAME: "admin"
  KEYCLOAK_ADMIN_PASSWORD: "admin"

---
# authbridge-config ConfigMap - Used by envoy-proxy for token exchange
#
# This ConfigMap controls two AuthBridge behaviors:
#   1. INBOUND validation: Validates JWT tokens on incoming requests to the agent
#   2. OUTBOUND exchange:  Exchanges tokens when the agent calls the GitHub tool
#
# The TARGET_AUDIENCE is the Keycloak client representing the GitHub tool.
# When the agent calls the tool, AuthBridge exchanges the incoming token for
# a new one with aud=github-tool, which the tool validates.
apiVersion: v1
kind: ConfigMap
metadata:
  name: authbridge-config
  namespace: team1
data:
  TOKEN_URL: "http://keycloak-service.keycloak.svc:8080/realms/demo/protocol/openid-connect/token"
  # ISSUER: Required. Must match the "iss" claim in tokens (Keycloak frontend URL).
  ISSUER: "http://keycloak.localtest.me:8080/realms/demo"
  # EXPECTED_AUDIENCE: The agent's SPIFFE ID. Validates inbound tokens are intended for this agent.
  # Format: spiffe://localtest.me/ns/<namespace>/sa/<service-account>
  # Update if deploying to a different namespace or using a different service account.
  EXPECTED_AUDIENCE: "spiffe://localtest.me/ns/team1/sa/git-issue-agent"
  # TARGET_AUDIENCE: The GitHub tool's Keycloak client ID.
  # AuthBridge exchanges tokens for this audience when the agent calls the tool.
  TARGET_AUDIENCE: "github-tool"
  # TARGET_SCOPES: Scopes to request in the exchanged token.
  # github-tool-aud adds "github-tool" to the token's audience claim.
  TARGET_SCOPES: "openid github-tool-aud"

---
# spiffe-helper-config ConfigMap - Used by spiffe-helper container (SPIRE mode only)
apiVersion: v1
kind: ConfigMap
metadata:
  name: spiffe-helper-config
  namespace: team1
data:
  helper.conf: |
    agent_address = "/spiffe-workload-api/spire-agent.sock"
    cmd = ""
    cmd_args = ""
    cert_dir = "/opt"
    renew_signal = ""
    svid_file_name = "svid.pem"
    svid_key_file_name = "svid_key.pem"
    svid_bundle_file_name = "svid_bundle.pem"
    jwt_svids = [{jwt_audience="kagenti", jwt_svid_file_name="jwt_svid.token"}]

---
# envoy-config ConfigMap - Envoy proxy configuration for traffic interception
# This configures Envoy to:
#   - Intercept outbound HTTP traffic and send it through ext-proc for token exchange
#   - Pass through outbound HTTPS traffic as-is (TLS passthrough)
#   - Intercept inbound HTTP traffic and send it through ext-proc for JWT validation
apiVersion: v1
kind: ConfigMap
metadata:
  name: envoy-config
  namespace: team1
data:
  envoy.yaml: |
    admin:
      address:
        socket_address:
          protocol: TCP
          address: 127.0.0.1
          port_value: 9901

    static_resources:
      listeners:
      - name: outbound_listener
        address:
          socket_address:
            protocol: TCP
            address: 0.0.0.0
            port_value: 15123
        listener_filters:
        - name: envoy.filters.listener.original_dst
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.original_dst.v3.OriginalDst
        - name: envoy.filters.listener.tls_inspector
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.tls_inspector.v3.TlsInspector
        filter_chains:
        # TLS passthrough: forward HTTPS traffic as-is via TCP proxy
        - filter_chain_match:
            transport_protocol: tls
          filters:
          - name: envoy.filters.network.tcp_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
              stat_prefix: outbound_tls_passthrough
              cluster: original_destination
        # Plaintext HTTP: inspect and process via ext_proc
        - filter_chain_match:
            transport_protocol: raw_buffer
          filters:
          - name: envoy.filters.network.http_connection_manager
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
              stat_prefix: outbound_http
              codec_type: AUTO
              route_config:
                name: outbound_routes
                virtual_hosts:
                - name: catch_all
                  domains: ["*"]
                  routes:
                  - match:
                      prefix: "/"
                    route:
                      cluster: original_destination
                      timeout: 300s
              http_filters:
              - name: envoy.filters.http.ext_proc
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.ext_proc.v3.ExternalProcessor
                  grpc_service:
                    envoy_grpc:
                      cluster_name: ext_proc_cluster
                    timeout: 300s
                  processing_mode:
                    request_header_mode: SEND
                    response_header_mode: SKIP
                    request_body_mode: NONE
                    response_body_mode: NONE
              - name: envoy.filters.http.router
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

      - name: inbound_listener
        address:
          socket_address:
            protocol: TCP
            address: 0.0.0.0
            port_value: 15124
        listener_filters:
        - name: envoy.filters.listener.original_dst
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.original_dst.v3.OriginalDst
        filter_chains:
        - filters:
          - name: envoy.filters.network.http_connection_manager
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
              stat_prefix: inbound_http
              codec_type: AUTO
              route_config:
                name: inbound_routes
                virtual_hosts:
                - name: local_app
                  domains: ["*"]
                  request_headers_to_add:
                  - header:
                      key: "x-authbridge-direction"
                      value: "inbound"
                    append: false
                  routes:
                  - match:
                      prefix: "/"
                    route:
                      cluster: original_destination
                      timeout: 300s
              http_filters:
              - name: envoy.filters.http.ext_proc
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.ext_proc.v3.ExternalProcessor
                  grpc_service:
                    envoy_grpc:
                      cluster_name: ext_proc_cluster
                    timeout: 300s
                  processing_mode:
                    request_header_mode: SEND
                    response_header_mode: SKIP
                    request_body_mode: NONE
                    response_body_mode: NONE
              - name: envoy.filters.http.router
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

      clusters:
      - name: original_destination
        connect_timeout: 30s
        type: ORIGINAL_DST
        lb_policy: CLUSTER_PROVIDED
        original_dst_lb_config:
          use_http_header: false

      - name: ext_proc_cluster
        connect_timeout: 5s
        type: STATIC
        lb_policy: ROUND_ROBIN
        http2_protocol_options: {}
        load_assignment:
          cluster_name: ext_proc_cluster
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: 127.0.0.1
                    port_value: 9090
