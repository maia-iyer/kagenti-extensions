# Agent Deployment for AuthBridge Webhook Demo (No SPIFFE)
#
# This is a simplified version that doesn't require SPIRE.
# The agent uses a static client ID instead of SPIFFE ID.
#
# This deployment uses the kagenti-webhook to automatically inject:
# - proxy-init (init container for iptables setup)
# - kagenti-client-registration (registers with Keycloak using static client ID)
# - envoy-proxy (intercepts traffic and performs token exchange)
#
# The agent container runs auth-proxy, which:
# - Listens on port 8080
# - Forwards requests to auth-target-service:8081
# - JWT validation is handled by the inbound ext-proc (injected by webhook)
# - Token exchange is handled by the outbound ext-proc (injected by webhook)
#
# Labels (must be on Pod template, not just Deployment):
#   kagenti.io/type: agent       - Required: identifies this as an agent workload
#   kagenti.io/inject: enabled   - Enables AuthBridge sidecar injection
#   kagenti.io/spire: disabled   - Disables SPIFFE-based identity (uses static client ID)
#
# Usage:
#   kubectl apply -f agent-deployment-webhook-no-spiffe.yaml

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: agent
  namespace: team1

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: agent
  namespace: team1
  labels:
    app: agent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: agent
  template:
    metadata:
      labels:
        app: agent
        kagenti.io/type: agent
        kagenti.io/inject: enabled
        kagenti.io/spire: disabled
    spec:
      serviceAccountName: agent
      containers:
        # auth-proxy - pass-through proxy (JWT validation handled by inbound ext-proc)
        - name: agent
          image: ghcr.io/kagenti/kagenti-extensions/auth-proxy:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
              name: http
          env:
            - name: TARGET_SERVICE_URL
              value: "http://auth-target-service:8081"
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 128Mi
          volumeMounts:
            - name: shared-data
              mountPath: /shared
      volumes:
        - name: shared-data
          emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: agent-service
  namespace: team1
spec:
  selector:
    app: agent
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
  type: ClusterIP
